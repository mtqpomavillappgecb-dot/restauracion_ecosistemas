---
title: "Projeto de Restauracion de Ecosistemas TESTE"
author: "Toa Quindi"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true # Ativa o sumário (Table of Contents)
    toc_depth: 3 # Define até qual nível de cabeçalho o sumário deve ir (e.g., ###)
    number_sections: true # Ativa a numeração automática das seções (e.g., 1, 1.1, 1.1.1)
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
  word_document:
    toc: true
    toc_depth: 3
    number_sections: true    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
## message e warning desligado nos chunks
```

# Introdución

Proyecto desarrollado para el modulo Fluxo de trabalho reproductivel em R, dictado por el professor Diogo Rocha y Hernani Ramos aplicado a un contexto de restauracion de ecosistema en la region sierra sur de Ecuador.

# Objetivo general

Criar uma estructura de trabalho de base para pesquisa de restauraçao de ecossitemas aplicado en la áreas protegidas de la sierra sur de Equador.
 
## Objetivos especificos

Definir las áreas de estudio
Definira las variables para el análisis de la variación
Analizar la variación de cada área desde el año 2000 hasta el año 2045

# Tarefas do trabalho

- Criar repositorio em Github (ok)
- Criar planilha con dados simulados (excel) (ok)
- Criar planilha con dados simulados (Google sheets) (ok)
- Criar dados históticos simulados del año 2000 (ok)
- Conectar la planilha de datos con Github (ok)
- Conectar repositorio e planilha com Rstudio (ok)
- Criar relatorio Rmarkdown (ok) 
- Checar impressao de relatorio em html (ok)
- Instalar MacTeX on macOS - https://tug.org/mactex/ (  )
- Checar impressao de relatorio em pdf (ok)
- Checar impressao de relatorio em word (ok)
- Fazer sumario estadistico de dados (ok)
- Organizar scripts (ok)

## Pacotes

```{r pacotes}
# instalacion y abrir pacotes
# install.packages(terra)
# install.packages(ggplot2)
# install.packages(dplyr)
# tinytex::install_tinytex() #Para windows 
# install.packages(MacTex) #Para mac instalar
# install.packages(readxl)
# install.packages("sf")
# install.packages("ggspatial")
# install.packages("ggsn")

library(terra)
library(ggplot2)
library(dplyr)
library(readr) 
library(googlesheets4) #código que abre o pacote.
library(sf)
library(rnaturalearth)
library(rnaturalearthdata) # Datos necesarios para rnaturalearth
library(ggspatial)

```

## Conexión con repositorio de dados 

<url reposistorio de disclipina>
<url reposistorio do projeto>
planilha <https://docs.google.com/spreadsheets/d/1_pp_YBuU1xgU2OD62DSHViigh90yhGJR2DeAujrFY3A/edit?usp=sharing> 

```{r google_sheets_conection, echo=FALSE}
## script para conexion con repositorio de dados

#O código echo=FALSE oculta o script no R Markdown.
#install.packages("googlesheets4") 
#desabilite o código após instalação.

gs4_deauth() #código que permite a conecxão sem autenticação.

url_dados <- "https://docs.google.com/spreadsheets/d/1_pp_YBuU1xgU2OD62DSHViigh90yhGJR2DeAujrFY3A/edit?usp=sharing" 
#código que conecta a sua planilha do Google Drive. 

# Se o nome da aba for realmente 'planilha1', mantenha como está
datos <- read_sheet(url_dados, sheet = "datos") # nomear planilha caso hajam varias
#dados2 <- read_sheet(url_planilha, sheet = "planilha2") # caso haja uma 2a planilha
#dados3 <- read_sheet(url_planilha, sheet = "planilha3") # caso haja uma 3a planilha

tibble(datos) # avalia natureza das variáveis e dados
#tibble(dados1) # avaliar dados da segunda planilha
#tibble(dados2) # avaliar dados da terceira planilha
```

### Sumario estadístico

```{r summario}
summary(datos)

```

## Area de estudo 

```{r mapa1}
#Escala nacional
#Datos de los países del mundo
world <- ne_countries(scale = "medium", returnclass = "sf")

#Filtrar el país deseado
ecuador <- subset(world, sovereignt == "Ecuador")

#Dibujar el mapa 
datos_sf <- st_as_sf(datos, coords = c("long", "lat"), crs = 4326)  #WGS84

linha_sf <- datos_sf %>%
  summarize(do_union = FALSE) %>% 
  st_cast("LINESTRING")

ggplot(data = ecuador) +
  geom_sf(fill = "antiquewhite", color = "gray60") +
  geom_sf(data = datos_sf, color = "red", size = 2) +        #pontos
  geom_sf(data = linha_sf, color = "blue", size = 0.1) +       #linha conectando
  labs(
    title = "Mapa de Ecuador",
    subtitle = "Dados provenientes da planilha",
    x = "Longitud", y = "Latitud"
  ) +
  theme_minimal()

```

```{r mapa2}
#Escala regional
getwd()
ruta_archivo <- setwd("/Users/pacha_cutig/Documents/Fluxo_trabalho_reproductivel_R/T_final/restauracion_ecosistemas")
shp1 <- st_read("Shp/Limite_prov_2019_est.shp")
shp2 <- st_read("Shp/SNAP_areas_est.shp")

datos_sf <- st_as_sf(datos, coords = c("long", "lat"), crs = 4326) 

ggplot() +
  geom_sf(data = shp1, aes(fill = "Provincia del Azuay")) +
  geom_sf(data = shp2, aes(fill = "Áreas de estudio_SNAP")) +
  scale_fill_manual(values = c("Provincia del Azuay" = "lightblue", "Áreas de estudio_SNAP" = "red")) +
  labs(title = "Mapa de áreas de estudio",
       x = "Longitud",
       y = "Latitud") +
  theme_minimal() # Aplica un tema más limpio
 
```

### Extracción de coordenadas máx y min

```{r limites}
bbox <- st_bbox(shp2)
print(bbox)

```

### Extracción de centroides

```{r centroides}
centroides <- st_centroid(shp2)  #Generar coodenadas de centroides  
coordenadas_xy <- st_coordinates(centroides)   #Para todos los centroides
print(coordenadas_xy)

```

### Tabelas

```{r tabelas}
#Ver las primeras filas de la tabla (como un data.frame)
head(st_drop_geometry(shp2))

#Convertir la tabla a un data.frame sin geometría
tabla <- st_drop_geometry(shp2)

#Proyección de datos
st_crs(shp2)

#Reproyectar a UTM adecuado (ajustar el EPSG según la zona)
shp2_m <- st_transform(shp2, 32717)
shp2_m$area_m2 <- st_area(shp2_m)
shp2_m$area_km2 <- as.numeric(shp2_m$area_m2) / 1e6

head(st_drop_geometry(shp2_m))

```

## Análisis

```{r analisis}
#Tablas de cvs
datos <- read_sheet(url_dados, sheet = "datos")

#Ver filas y columnas específicas
datos_res <- datos|>
  filter(area == "Reserva1") |>
  select(2, 3, 4, 7, 9)
head(datos_res, 40)


```

## Gráficos

```{r graficos}
#Criar mapas con serie histórica de evolucion desde el 2000 hasta 20 años de monitoreo de restauración.
datos <- read_sheet(url_dados, sheet = "datos")

ggplot(datos, aes(x = ano, y = score_yes_n, color = area)) +
  geom_smooth(se = FALSE, size = 1.2, method = "loess") +
  facet_wrap(~ ecosistema) +
  labs(
    title = "Tendencia por año con restauración",
    x = "Año",
    y = "Score",
    color = "Área"
  ) +
  theme_minimal(base_size = 14)

ggplot(datos, aes(x = ano, y = score_no_n, color = area)) +
  geom_smooth(se = FALSE, size = 1.2, method = "loess") +
  facet_wrap(~ ecosistema) +
  labs(
    title = "Tendencia por año sin restauración",
    x = "Año",
    y = "Score",
    color = "Área"
  ) +
  theme_minimal(base_size = 14)

```







