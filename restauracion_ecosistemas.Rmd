---
title: "Projeto de Restauracion de Ecosistemas TESTE"
author: "Toa Quindi"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true # Ativa o sumário (Table of Contents)
    toc_depth: 3 # Define até qual nível de cabeçalho o sumário deve ir (e.g., ###)
    number_sections: true # Ativa a numeração automática das seções (e.g., 1, 1.1, 1.1.1)
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
  word_document:
    toc: true
    toc_depth: 3
    number_sections: true    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
## message e warning desligado nos chunks
```

# Introdución

Proyecto desarrollado para el modulo Fluxo de trabalho reproductivel em R, dictado por el professor Diogo Rocha y Hernani Ramos aplicado a un contexto de restauracion de ecosistema en la region sierra sur de Ecuador.

## Objetivo general

Criar uma estructura de trabalho de base para pesquisa de restauraçao de ecossitemas aplicado en la áreas protegidas de la sierra sur de Equador.
 
### Objetivos especificos

Elaborar con calma.

## Tarefas do trabalho

- Criar repositorio em Github (ok)
- Criar planilha con dados simulados (excel) (ok)
- Criar planilha con dados simulados (Google sheets) (ok)
- Criar dados históticos simulados del año 2000 (ok)
- Conectar la planilha de datos con Github (ok)
- Conectar repositorio e planilha com Rstudio (ok)
- Criar relatorio Rmarkdown (ok) 
- Checar impressao de relatorio em html (ok)
- Instalar MacTeX on macOS - https://tug.org/mactex/ (  )
- Checar impressao de relatorio em pdf (  )
- Checar impressao de relatorio em word (ok)
- Fazer sumario estadistico de dados (ok)
- Organizar scripts (  )
> Criar um mapa de area de estudo pacote Terra
> Criar tabelas
> Criar graficos como pacote ggpplot2

## Instalacion de pacotes

```{r pacotes}
# instalacion y abrir pacotes
# install.packages(terra)
# install.packages(ggplot2)
# install.packages(dplyr)
# tinytex::install_tinytex() #Para windows 
# install.packages(MacTex) #Para mac instalar
# install.packages(readxl)
# install.packages("sf")
# install.packages("ggspatial")
# install.packages("ggsn")

library(terra)
library(ggplot2)
library(dplyr)
library(readr) 
library(googlesheets4) #código que abre o pacote.
library(sf)
library(rnaturalearth)
library(rnaturalearthdata) # Datos necesarios para rnaturalearth
library(ggspatial)

```

## Conectar repositorio de dados 

<url reposistorio de disclipina>
<url reposistorio do projeto>
planilha <https://docs.google.com/spreadsheets/d/1_pp_YBuU1xgU2OD62DSHViigh90yhGJR2DeAujrFY3A/edit?usp=sharing> 

```{r google_sheets_conection, echo=FALSE}
## script para conexion con repositorio de dados

#O código echo=FALSE oculta o script no R Markdown.
#install.packages("googlesheets4") 
#desabilite o código após instalação.

gs4_deauth() #código que permite a conecxão sem autenticação.

url_dados <- "https://docs.google.com/spreadsheets/d/1_pp_YBuU1xgU2OD62DSHViigh90yhGJR2DeAujrFY3A/edit?usp=sharing" 
#código que conecta a sua planilha do Google Drive. 

# Se o nome da aba for realmente 'planilha1', mantenha como está
datos <- read_sheet(url_dados, sheet = "datos") # nomear planilha caso hajam varias
#dados2 <- read_sheet(url_planilha, sheet = "planilha2") # caso haja uma 2a planilha
#dados3 <- read_sheet(url_planilha, sheet = "planilha3") # caso haja uma 3a planilha

tibble(datos) # avalia natureza das variáveis e dados
#tibble(dados1) # avaliar dados da segunda planilha
#tibble(dados2) # avaliar dados da terceira planilha
```


## Sumario estadistico

```{r summario}
#script para visualizacion de dados
#summary(datos)
head(datos)
plot(datos$long, datos$lat)

```

## Area de estudo 
- Fazer figura 1 com mapa de Equador
- Considerar pacote Terra, GGMAP, GGPLOT2
- Incluir Norte, escala, Shp de pais, region y 2 areas de estudio

```{r mapa1}
# script para crear mapa com Terra 
# escala nacional

# Obtener los datos de los países del mundo
world <- ne_countries(scale = "medium", returnclass = "sf")

# Filtrar por el país deseado
ecuador <- subset(world, sovereignt == "Ecuador")

# Dibujar el mapa 
datos_sf <- st_as_sf(datos, coords = c("long", "lat"), crs = 4326)  # WGS84

linha_sf <- datos_sf %>%
  summarize(do_union = FALSE) %>% 
  st_cast("LINESTRING")

ggplot(data = ecuador) +
  geom_sf(fill = "antiquewhite", color = "gray60") +
  geom_sf(data = datos_sf, color = "red", size = 2) +        # pontos
  geom_sf(data = linha_sf, color = "blue", size = 0.1) +       # linha conectando
  labs(
    title = "Mapa de Ecuador com pontos e conexões",
    subtitle = "Dados provenientes da planilha",
    x = "Longitud", y = "Latitud"
  ) +
  theme_minimal()

```

- Fazer figura 2 com mapa regional, cambiar escala
- Considerar pacote Terra, GGMAP, GGPLOT2
- Incluir Norte, escala, Shp de region, provincias y 2 areas de estudio
- Incluir os 2 grids (100 x 100 m)
- Incluir coordenadas dos centroides de los grids

```{r mapa2}
# script para crear mapa com Terra
# escala regional
getwd()
ruta_archivo <- setwd("/Users/pacha_cutig/Documents/Fluxo_trabalho_reproductivel_R/T_final/restauracion_ecosistemas")
shp1 <- st_read("Shp/Limite_prov_2019_est.shp")
shp2 <- st_read("Shp/SNAP_areas_est.shp")

datos_sf <- st_as_sf(datos, coords = c("long", "lat"), crs = 4326) 

ggplot() +
  geom_sf(data = shp1, aes(fill = "Provincia del Azuay")) +
  geom_sf(data = shp2, aes(fill = "Áreas de estudio_SNAP")) +
  scale_fill_manual(values = c("Provincia del Azuay" = "lightblue", "Áreas de estudio_SNAP" = "red")) +
  labs(title = "Mapa de áreas de estudio",
       x = "Longitud",
       y = "Latitud") +
  theme_minimal() # Aplica un tema más limpio
 
```

#Extraer coordenadas
-Extraer coordenadas limites max, min de cada area

```{r limites}
bbox <- st_bbox(shp2)
print(bbox)

```

-Extraer coordenadas centroides

```{r centroides}
#generar coodenadas de centroides
centroides <- st_centroid(shp2)
# Para todos los centroides
coordenadas_xy <- st_coordinates(centroides)
print(coordenadas_xy)

```

## Tabelas

```{r tabelas}
# elabora scripts para tabelas

# Ver las primeras filas de la tabla (como un data.frame)
head(st_drop_geometry(shp2))
# Convertir la tabla a un data.frame sin geometría
tabla <- st_drop_geometry(shp2)
# Guardar como CSV
write.csv(tabla, "tabla_shapefile.csv", row.names = FALSE)

```

## Analisis

```{r analisis}
#elaborar scripts
#proyección de datos
st_crs(shp2)
# Reproyectar a UTM adecuado (ajustar el EPSG según la zona)
shp2_m <- st_transform(shp2, 32717)
shp2_m$area_m2 <- st_area(shp2_m)
shp2_m$area_km2 <- as.numeric(shp2_m$area_m2) / 1e6
# Ver las primeras filas con el área
head(st_drop_geometry(shp2_m))

#tablas de cvs
datos <- read_sheet(url_dados, sheet = "datos")

# Ver filas y columnas específicas
datos_res <- datos|>
  filter(area == "Reserva1") |>
  select(2, 3, 4, 7, 9)
head(datos_res, 40)

summary(datos)

```

## Graficos

```{r graficos}
#elaborar scripts para graficos com ggplot2
#elaborar boxplot com ggplot entre ano e cantidades de arbustos
#Agrupar graficos temporales de las areas sin y con manejo
#Criar mapas con serie histórica de evolucion desde el 2000 hasta 20 años de monitoreo de restauración.



```

## Tarefas pendientes

- Definir coorientadores para teses (1 o 2)
- Contactar con colaboradores de Ecuador URG!!
- Elaborar planes de accion dependiendo del score





